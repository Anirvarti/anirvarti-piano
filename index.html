<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Satya: Pro Audio Synthesizer</title>
    <style>
        :root {
            /* Responsive Proportions */
            --white-key-width: calc(100% / 52); 
            --white-key-height: 30vh;
            --black-key-width: calc(var(--white-key-width) * 0.65); 
            --black-key-height: 18vh;
            
            /* UI Colors */
            --panel-bg: linear-gradient(to bottom, #2b2e33, #1a1c1f);
            --metal-border: #444a52;
            --lcd-bg: #09151c;
            --lcd-text: #00ffea;
        }

        body {
            display: flex;
            justify-content: flex-start; 
            align-items: center;
            height: 100vh;
            background: radial-gradient(circle at center, #2a3340 0%, #0d1117 100%);
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            overflow-y: hidden; 
        }

        /* Main Software Window */
        .software-window {
            background: var(--panel-bg);
            border: 1px solid #111;
            border-top: 1px solid #555;
            border-radius: 8px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.8), 0 0 0 1px #000;
            display: flex;
            flex-direction: column;
            margin: 0 auto;
            min-width: max-content;
        }

        /* Control Panel (Top Section) */
        .control-panel {
            display: flex;
            align-items: stretch;
            height: 120px;
            padding: 15px 30px;
            gap: 15px;
            background: linear-gradient(to bottom, #222, #181818);
            border-bottom: 2px solid #0a0a0a;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
            border-radius: 8px 8px 0 0;
        }

        /* Mock UI Modules */
        .ui-module {
            background: linear-gradient(to bottom, #1e1e1e, #141414);
            border: 1px solid #333;
            border-top: 1px solid #444;
            border-radius: 4px;
            padding: 10px 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
        }

        .ui-title {
            font-size: 0.6rem;
            color: #88929e;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            white-space: nowrap;
        }

        /* Mock Knobs */
        .knob-row {
            display: flex;
            gap: 15px;
        }
        .knob-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .knob {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: radial-gradient(circle at top, #555, #222);
            border: 2px solid #111;
            box-shadow: 0 4px 5px rgba(0,0,0,0.6), inset 0 1px 2px rgba(255,255,255,0.2);
            position: relative;
            cursor: ns-resize;
        }
        .knob::after {
            content: '';
            position: absolute;
            top: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 10px;
            background: #fff;
            border-radius: 2px;
        }
        .knob:active {
            box-shadow: 0 2px 3px rgba(0,0,0,0.8), inset 0 1px 3px rgba(255,255,255,0.1);
        }
        .knob-label {
            font-size: 0.55rem;
            color: #666;
            text-transform: uppercase;
        }

        /* UI Buttons & Selects */
        .ai-input, .ui-select {
            background: #090a0c;
            border: 1px solid #333;
            color: #00ffea;
            padding: 5px 10px;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.75rem;
            outline: none;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.8);
        }
        .ai-btn {
            background: linear-gradient(to bottom, #2a4040, #142222);
            border: 1px solid #00ffea;
            color: #00ffea;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.7rem;
            text-transform: uppercase;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5), inset 0 1px 2px rgba(255,255,255,0.1);
            transition: all 0.1s;
        }
        .ai-btn:hover { background: linear-gradient(to bottom, #3b5c5c, #1f3636); box-shadow: 0 0 10px rgba(0, 255, 234, 0.3); }
        .ai-btn:active { transform: translateY(2px); box-shadow: 0 1px 2px rgba(0,0,0,0.8); }

        /* Recording Button */
        .rec-btn {
            background: linear-gradient(to bottom, #4a1515, #220505);
            border: 1px solid #ff4444;
            color: #ff4444;
        }
        .rec-btn:hover { background: linear-gradient(to bottom, #6a1c1c, #330808); box-shadow: 0 0 10px rgba(255, 68, 68, 0.3); }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 5px #f00; } 50% { box-shadow: 0 0 20px #f00; } 100% { box-shadow: 0 0 5px #f00; }
        }
        .rec-btn.recording {
            animation: pulse-red 1s infinite;
            background: #ff0000;
            color: white;
            border-color: #fff;
        }

        /* Pedal UI */
        .pedal-module {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 0 10px;
        }
        .pedal-button {
            width: 40px;
            height: 60px;
            background: linear-gradient(to bottom, #d4af37, #997a00);
            border: 2px solid #222;
            border-radius: 4px 4px 15px 15px;
            box-shadow: 0 10px 10px rgba(0,0,0,0.6), inset 0 2px 5px rgba(255,255,255,0.4);
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s, background 0.1s;
        }
        .pedal-button.active {
            transform: translateY(8px) rotateX(15deg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.8), inset 0 1px 2px rgba(255,255,255,0.2);
            background: linear-gradient(to bottom, #b3922b, #7a6100);
        }

        /* Center LCD Display + Visualizer */
        .lcd-display {
            flex-grow: 1;
            background: var(--lcd-bg);
            border: 2px solid #000;
            border-radius: 4px;
            box-shadow: inset 0 0 15px rgba(0,0,0,1), 0 1px 0 rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            min-width: 250px;
        }
        .lcd-display::before { 
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px; pointer-events: none; z-index: 3;
        }
        .visualizer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
            opacity: 0.6;
        }
        .lcd-main-text {
            color: var(--lcd-text);
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.4rem;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(0, 255, 234, 0.6);
            letter-spacing: 1px;
            z-index: 2;
        }
        .lcd-sub-text {
            color: #4a8282;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.7rem;
            margin-top: 5px;
            z-index: 2;
        }

        /* App Logo */
        .app-brand {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-end;
            min-width: 120px;
        }
        .brand-name { font-size: 1.6rem; font-weight: 800; letter-spacing: -1px; color: #ddd; text-shadow: 0 2px 2px rgba(0,0,0,1); font-style: italic; }
        .brand-sub { font-size: 0.6rem; color: #777; letter-spacing: 2px; }

        /* AI & Sys Bar */
        .ai-bar {
            display: flex;
            align-items: center;
            padding: 10px 30px;
            background: linear-gradient(to right, #111, #1a1c1f, #111);
            border-bottom: 2px solid #000;
            gap: 15px;
        }
        
        .ai-input { flex-grow: 1; font-size: 0.9rem; padding: 8px 15px; }

        /* Red Felt Strip */
        .red-felt {
            height: 14px;
            background: linear-gradient(to bottom, #8a0b0b, #590000);
            border-bottom: 2px solid #330000;
            border-top: 1px solid #111;
            box-shadow: inset 0 4px 4px rgba(0,0,0,0.6), 0 2px 5px rgba(0,0,0,0.8);
            position: relative;
            z-index: 10;
        }

        /* Keyboard Layout */
        .piano-wrapper {
            position: relative;
            width: 98vw;
            max-width: 1800px;
            background: #000;
            padding: 0 10px 15px 10px;
            border-radius: 0 0 8px 8px;
        }
        .piano { display: flex; position: relative; width: 100%; padding-top: 2px; }

        .key {
            cursor: pointer;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            user-select: none;
            -webkit-user-select: none;
            -webkit-user-drag: none; 
        }
        .white-key {
            width: var(--white-key-width); height: var(--white-key-height);
            background: linear-gradient(to bottom, #ffffff 0%, #f4f4f4 85%, #e0e0e0 100%);
            border: 1px solid #a0a0a0; border-top: none; border-radius: 0 0 5px 5px; z-index: 1;
            box-shadow: inset 1px 0 0px #fff, inset -1px 0 0px rgba(0,0,0,0.1), inset 0 -8px 0px #d0d0d0, inset 0 -9px 0px #999, 0 6px 8px rgba(0,0,0,0.4);
            padding-bottom: 20px;
        }
        .white-key.active {
            height: calc(var(--white-key-height) - 4px); transform: translateY(4px);
            background: linear-gradient(to bottom, #f0f0f0 0%, #e4e4e4 85%, #d0d0d0 100%);
            box-shadow: inset 1px 0 0px #fff, inset -1px 0 0px rgba(0,0,0,0.1), inset 0 -4px 0px #c0c0c0, inset 0 -5px 0px #888, 0 2px 3px rgba(0,0,0,0.4);
        }
        .black-key {
            width: var(--black-key-width); height: var(--black-key-height);
            background: linear-gradient(to bottom, #303030 0%, #1a1a1a 85%, #050505 100%);
            position: absolute; z-index: 2; margin-left: calc(var(--black-key-width) / -2); border-radius: 0 0 3px 3px; border: 1px solid #000; border-top: none;
            box-shadow: inset 3px 0 3px rgba(255,255,255,0.15), inset -3px 0 3px rgba(0,0,0,0.8), inset 0 -10px 4px #111, inset 0 -11px 0 #000, 0 8px 10px rgba(0,0,0,0.7);
            padding-bottom: 15px;
        }
        .black-key.active {
            height: calc(var(--black-key-height) - 3px); transform: translateY(3px);
            background: linear-gradient(to bottom, #252525 0%, #111 85%, #000 100%);
            box-shadow: inset 2px 0 2px rgba(255,255,255,0.1), inset -2px 0 2px rgba(0,0,0,0.8), inset 0 -6px 4px #0a0a0a, inset 0 -7px 0 #000, 0 3px 4px rgba(0,0,0,0.7);
        }

        .note-name {
            font-weight: 700; font-size: 0.55rem; color: transparent; margin-bottom: 2px;
            text-shadow: 0px 1px 1px rgba(255,255,255,0.8), 0px -1px 1px rgba(0,0,0,0.3);
            writing-mode: vertical-rl; transform: rotate(180deg); margin-top: auto; padding-top: 5px;
        }
        .black-key .note-name { text-shadow: 0px 1px 1px rgba(255,255,255,0.15), 0px -1px 1px rgba(0,0,0,0.8); font-size: 0.5rem; }
        .key-bind { font-size: 0.5rem; font-weight: bold; text-transform: uppercase; color: rgba(220, 50, 50, 0.7); margin-bottom: 5px; }
        
        /* MIDI Indicator */
        .midi-led {
            width: 8px; height: 8px; border-radius: 50%; background: #333; margin-top: 5px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.8);
            transition: background 0.1s;
        }
        .midi-led.active { background: #00ffea; box-shadow: 0 0 8px #00ffea; }

        @media (max-width: 900px) {
            .control-panel { height: auto; flex-wrap: wrap; justify-content: center; }
            .lcd-display { order: -1; min-width: 100%; height: 70px; }
            .app-brand { display: none; }
            .note-name, .key-bind { display: none; } 
        }
    </style>
</head>
<body>

    <div class="piano-wrapper" id="piano-wrapper">
        <div class="software-window">
            
            <!-- Control Panel -->
            <div class="control-panel">
                <div class="ui-module">
                    <span class="ui-title">Presets & Rec</span>
                    <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                        <select id="preset-select" class="ui-select" style="width: 100px;">
                            <optgroup label="Built-in" id="built-in-presets">
                                <option value="default">Satya Concert Grand</option>
                                <option value="saloon">Satya Saloon Piano</option>
                                <option value="felt">Satya Soft Felt</option>
                            </optgroup>
                            <optgroup label="Saved" id="saved-presets"></optgroup>
                        </select>
                        <button id="save-preset-btn" class="ai-btn" style="padding: 5px;">üíæ</button>
                    </div>
                    <button id="record-btn" class="ai-btn rec-btn" style="width: 100%;">‚è∫ RECORD</button>
                </div>

                <div class="ui-module">
                    <span class="ui-title">Tuning</span>
                    <div class="knob-row">
                        <div class="knob-container">
                            <div class="knob" id="knob-diapason"></div>
                            <span class="knob-label">Diapason</span>
                        </div>
                        <div class="knob-container">
                            <div class="knob" id="knob-unison"></div>
                            <span class="knob-label">Unison</span>
                        </div>
                    </div>
                </div>

                <div class="ui-module">
                    <span class="ui-title">Voicing</span>
                    <div class="knob-row">
                        <div class="knob-container">
                            <div class="knob" id="knob-hammer"></div>
                            <span class="knob-label">Hammer</span>
                        </div>
                        <div class="knob-container">
                            <div class="knob" id="knob-strike"></div>
                            <span class="knob-label">Strike</span>
                        </div>
                    </div>
                </div>

                <!-- Octave Shifter UI -->
                <div class="ui-module" style="align-items: center; justify-content: center; flex-direction: row; gap: 8px;">
                    <button id="octave-down" class="ai-btn" style="padding: 5px 8px;">‚óÄ</button>
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <span class="ui-title">Octave</span>
                        <span id="octave-shift-label" style="font-family: 'Courier New'; font-weight: bold; color: var(--lcd-text);">0</span>
                    </div>
                    <button id="octave-up" class="ai-btn" style="padding: 5px 8px;">‚ñ∂</button>
                </div>

                <!-- LCD + Visualizer -->
                <div class="lcd-display">
                    <canvas id="visualizer" class="visualizer"></canvas>
                    <div class="lcd-main-text" id="lcd-main">Anirvarti Satya</div>
                    <div class="lcd-sub-text">PHYSICAL MODELING ENG.</div>
                </div>
                
                <div class="pedal-module">
                    <div class="pedal-button" id="sustain-pedal"></div>
                    <span class="knob-label">Sustain</span>
                </div>

                <div class="ui-module" style="align-items: center; justify-content: center; flex-direction: row; gap: 15px;">
                    <div class="knob-container">
                        <div class="knob" id="knob-reverb"></div>
                        <span class="knob-label" style="margin-top:5px;">Reverb</span>
                    </div>
                    <div class="knob-container">
                        <div class="knob" id="knob-volume"></div>
                        <span class="knob-label" style="margin-top:5px;">Volume</span>
                    </div>
                </div>

                <div class="app-brand">
                    <div class="brand-name">Satya</div>
                    <div class="brand-sub">PRO AUDIO</div>
                    <div style="display: flex; align-items: center; gap: 5px; margin-top: 5px;">
                        <span class="ui-title" style="color: #555;">MIDI</span>
                        <div id="midi-led" class="midi-led"></div>
                    </div>
                </div>
            </div>

            <!-- AI Voicing Engineer Bar -->
            <div class="ai-bar">
                <input type="text" id="ai-prompt" class="ai-input" placeholder="‚ú® Describe a tone (e.g. 'dusty saloon piano' or 'cinematic dark felt')...">
                <button id="ai-btn" class="ai-btn">‚ú® Auto-Voice</button>
            </div>

            <div class="red-felt"></div>

            <div class="piano" id="piano">
                <!-- Keys generated by JS -->
            </div>
            
        </div>
    </div>

    <script>
        const apiKey = ""; // API Key provided by execution environment
        
        let audioCtx;
        let globalBus, compressor, convolver, reverbGain, analyser, recordingDest, mediaRecorder;
        let recordedChunks = [];
        
        const pianoContainer = document.getElementById('piano');
        const lcdMain = document.getElementById('lcd-main');
        const keyElements = {}; 
        let whiteKeyCount = 0;

        // --- Engine Parameters & Presets ---
        const params = { diapason: 440, unison: 0.2, hammer: 0.5, strike: 0.5, reverb: 0.4, volume: 0.8 };
        
        const defaultPresets = {
            default: { name: "Satya Concert Grand", p: { diapason: 440, unison: 0.2, hammer: 0.5, strike: 0.5, reverb: 0.4, volume: 0.8 } },
            saloon:  { name: "Satya Saloon Piano",  p: { diapason: 440, unison: 0.8, hammer: 0.85, strike: 0.8, reverb: 0.1, volume: 0.8 } },
            felt:    { name: "Satya Soft Felt",     p: { diapason: 440, unison: 0.1, hammer: 0.1, strike: 0.2, reverb: 0.6, volume: 0.9 } }
        };
        let customPresets = JSON.parse(localStorage.getItem('jsteq_presets') || '{}');

        const activeVoices = {}; 
        const heldKeys = new Set(); 
        let isSustainPedalDown = false;
        let currentOctaveShift = 0;

        // Hardware Keyboard Mapping
        const baseKeyMap = {
            'KeyZ': -12, 'KeyX': -10, 'KeyC': -8, 'KeyV': -7, 'KeyB': -5, 'KeyN': -3, 'KeyM': -1, 'Comma': 0, 'Period': 2, 'Slash': 4,
            'KeyA': 0, 'KeyW': 1, 'KeyS': 2, 'KeyE': 3, 'KeyD': 4, 'KeyF': 5, 'KeyT': 6, 'KeyG': 7, 'KeyY': 8, 'KeyH': 9, 'KeyU': 10, 'KeyJ': 11, 'KeyK': 12,
            'KeyO': 13, 'KeyL': 14, 'KeyP': 15, 'Semicolon': 16, 'Quote': 17
        };
        const keyDisplayMap = {
            'KeyZ': 'Z', 'KeyX': 'X', 'KeyC': 'C', 'KeyV': 'V', 'KeyB': 'B', 'KeyN': 'N', 'KeyM': 'M', 'Comma': ',', 'Period': '.', 'Slash': '/',
            'KeyA': 'A', 'KeyW': 'W', 'KeyS': 'S', 'KeyE': 'E', 'KeyD': 'D', 'KeyF': 'F', 'KeyT': 'T', 'KeyG': 'G', 'KeyY': 'Y', 'KeyH': 'H', 'KeyU': 'U', 'KeyJ': 'J', 'KeyK': 'K',
            'KeyO': 'O', 'KeyL': 'L', 'KeyP': 'P', 'Semicolon': ';', 'Quote': "'"
        };

        const notes = [];
        const noteNames = ['A', 'A#', 'B', 'C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#'];
        for (let i = 1; i <= 88; i++) {
            const nameIndex = (i - 1) % 12;
            const name = noteNames[nameIndex];
            const octave = Math.floor((i + 8) / 12); 
            notes.push({ index: i, name: name + octave, type: name.includes('#') ? 'black' : 'white' });
        }

        // --- Core Audio Initialization ---
        function initAudio() {
            if (!audioCtx) {
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    audioCtx = new AudioContext();

                    globalBus = audioCtx.createGain();
                    
                    // Compressor
                    compressor = audioCtx.createDynamicsCompressor();
                    compressor.threshold.value = -24; compressor.knee.value = 30; compressor.ratio.value = 4;
                    compressor.attack.value = 0.003; compressor.release.value = 0.25;

                    // Reverb
                    convolver = audioCtx.createConvolver();
                    const length = audioCtx.sampleRate * 2.5; 
                    const impulse = audioCtx.createBuffer(2, length, audioCtx.sampleRate);
                    const decayFactor = Math.exp(-1 / (audioCtx.sampleRate * 0.5));
                    let runningDecay = 1.0;
                    for (let i = 0; i < length; i++) {
                        impulse.getChannelData(0)[i] = (Math.random() * 2 - 1) * runningDecay;
                        impulse.getChannelData(1)[i] = (Math.random() * 2 - 1) * runningDecay;
                        runningDecay *= decayFactor;
                    }
                    convolver.buffer = impulse;
                    reverbGain = audioCtx.createGain();
                    reverbGain.gain.value = params.reverb;

                    // Visualizer & Recording Setup
                    analyser = audioCtx.createAnalyser();
                    analyser.fftSize = 1024;
                    recordingDest = audioCtx.createMediaStreamDestination();

                    // Routing: Bus -> Convolver(Reverb) -> Compressor -> Destination/Analyser/Record
                    globalBus.connect(compressor);
                    globalBus.connect(convolver);
                    convolver.connect(reverbGain);
                    reverbGain.connect(compressor);
                    
                    compressor.connect(audioCtx.destination);
                    compressor.connect(analyser);
                    compressor.connect(recordingDest);

                    drawVisualizer();
                    initMIDI(); // Request MIDI access once Audio Context is ready
                } catch(e) { console.error("Web Audio API Error: ", e); }
            }
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        }

        // --- Visualizer ---
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        function drawVisualizer() {
            requestAnimationFrame(drawVisualizer);
            if (!analyser) return;
            
            // Match canvas internal resolution to display size
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteTimeDomainData(dataArray);

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#00ffea';
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#00ffea';
            ctx.beginPath();
            
            const sliceWidth = canvas.width * 1.0 / bufferLength;
            let x = 0;
            for(let i = 0; i < bufferLength; i++) {
                const v = dataArray[i] / 128.0;
                const y = v * canvas.height / 2;
                if(i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
                x += sliceWidth;
            }
            ctx.stroke();
        }

        // --- Web MIDI Integration ---
        function initMIDI() {
            if (navigator.requestMIDIAccess) {
                navigator.requestMIDIAccess().then(
                    (midiAccess) => {
                        const led = document.getElementById('midi-led');
                        const inputs = midiAccess.inputs.values();
                        for (let input of inputs) {
                            input.onmidimessage = (message) => handleMIDIMessage(message, led);
                            led.style.background = '#0a0'; // Standby green
                        }
                        midiAccess.onstatechange = (e) => {
                            if(e.port.state === 'connected') e.port.onmidimessage = (msg) => handleMIDIMessage(msg, led);
                        };
                    },
                    (err) => console.log("MIDI access denied or unsupported.", err)
                );
            }
        }

        function handleMIDIMessage(message, led) {
            led.classList.add('active');
            setTimeout(() => led.classList.remove('active'), 50);

            const command = message.data[0];
            const midiNote = message.data[1];
            const velocity = (message.data.length > 2) ? message.data[2] : 0;

            if (command >= 144 && command <= 159) { // Note On (all channels)
                if (velocity > 0) noteOnMIDI(midiNote, velocity);
                else noteOffMIDI(midiNote);
            } else if (command >= 128 && command <= 143) { // Note Off
                noteOffMIDI(midiNote);
            } else if (command >= 176 && command <= 191) { // Control Change
                if (midiNote === 64) setPedal(velocity > 63); // Sustain Pedal CC
            }
        }

        function noteOnMIDI(midiNote, velocity) {
            // MIDI Note 21 is A0 (our index 1). Index = midiNote - 20
            const index = midiNote - 20;
            if (index > 0 && index <= 88) {
                const noteObj = notes[index - 1];
                heldKeys.add(noteObj.name);
                playNote(index, noteObj.name, velocity / 127);
                const div = document.getElementById(`key-${noteObj.name}`);
                if (div) div.classList.add('active');
            }
        }

        function noteOffMIDI(midiNote) {
            const index = midiNote - 20;
            if (index > 0 && index <= 88) {
                const noteObj = notes[index - 1];
                const div = document.getElementById(`key-${noteObj.name}`);
                if (div) div.classList.remove('active');
                releaseNote(noteObj.name);
            }
        }

        // --- Recording Studio ---
        const recBtn = document.getElementById('record-btn');
        recBtn.addEventListener('click', () => {
            initAudio();
            if(!mediaRecorder) {
                mediaRecorder = new MediaRecorder(recordingDest.stream);
                mediaRecorder.ondataavailable = (e) => { if(e.data.size > 0) recordedChunks.push(e.data); };
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'audio/webm' });
                    recordedChunks = [];
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = 'SATYA_Recording.webm';
                    document.body.appendChild(a); a.click(); document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                };
            }
            
            if (mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                recBtn.classList.remove('recording');
                recBtn.innerText = '‚è∫ RECORD';
            } else {
                mediaRecorder.start();
                recBtn.classList.add('recording');
                recBtn.innerText = '‚èπ STOP (SAVE)';
            }
        });

        // --- Presets Manager ---
        const presetSelect = document.getElementById('preset-select');
        const savedGroup = document.getElementById('saved-presets');
        
        function updatePresetDropdown() {
            savedGroup.innerHTML = '';
            for (let key in customPresets) {
                const opt = document.createElement('option');
                opt.value = key; opt.innerText = customPresets[key].name;
                savedGroup.appendChild(opt);
            }
        }
        updatePresetDropdown();

        function applyPreset(presetKey) {
            const pData = defaultPresets[presetKey] || customPresets[presetKey];
            if(!pData) return;
            document.getElementById('knob-diapason').setValue(pData.p.diapason);
            document.getElementById('knob-unison').setValue(pData.p.unison);
            document.getElementById('knob-hammer').setValue(pData.p.hammer);
            document.getElementById('knob-strike').setValue(pData.p.strike);
            document.getElementById('knob-reverb').setValue(pData.p.reverb);
            document.getElementById('knob-volume').setValue(pData.p.volume);
            lcdMain.innerText = pData.name.toUpperCase();
        }

        presetSelect.addEventListener('change', (e) => applyPreset(e.target.value));

        document.getElementById('save-preset-btn').addEventListener('click', () => {
            const name = prompt("Name your custom piano preset:");
            if(name) {
                const key = 'custom_' + Date.now();
                customPresets[key] = { name: name, p: { ...params } };
                localStorage.setItem('jsteq_presets', JSON.stringify(customPresets));
                updatePresetDropdown();
                presetSelect.value = key;
                lcdMain.innerText = name.toUpperCase();
            }
        });

        // --- Interactive Knobs Setup ---
        function setupKnob(id, paramKey, min, max, initialVal) {
            const knob = document.getElementById(id);
            if (!knob) return;
            
            let val = initialVal;
            params[paramKey] = val;

            const updateVisuals = () => {
                const pct = (val - min) / (max - min);
                const deg = -135 + (pct * 270);
                knob.style.transform = `rotate(${deg}deg)`;
            };
            updateVisuals();

            knob.setValue = (newVal) => {
                val = Math.max(min, Math.min(max, newVal));
                params[paramKey] = val;
                updateVisuals();
                if (paramKey === 'reverb' && reverbGain) reverbGain.gain.setValueAtTime(val, audioCtx?.currentTime || 0);
            };

            let startY, startVal;
            knob.addEventListener('mousedown', (e) => {
                startY = e.clientY; startVal = val;
                window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp);
                document.body.style.cursor = 'ns-resize';
            });

            function onMove(e) {
                const deltaY = startY - e.clientY; const range = max - min;
                val = Math.max(min, Math.min(max, startVal + (deltaY * 0.005 * range)));
                params[paramKey] = val;
                updateVisuals();
                if (paramKey === 'reverb' && reverbGain) reverbGain.gain.setValueAtTime(val, audioCtx.currentTime);
                presetSelect.value = ''; // Detach from preset when modified manually
            }
            function onUp() {
                window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp);
                document.body.style.cursor = 'default';
            }
        }

        // --- Sustain Pedal Setup ---
        const pedalBtn = document.getElementById('sustain-pedal');
        function setPedal(state) {
            isSustainPedalDown = state;
            if (state) {
                pedalBtn.classList.add('active');
            } else {
                pedalBtn.classList.remove('active');
                const now = audioCtx ? audioCtx.currentTime : 0;
                for (let noteName in activeVoices) {
                    if (!heldKeys.has(noteName)) {
                        activeVoices[noteName].stop(now);
                        delete activeVoices[noteName];
                    }
                }
            }
        }
        pedalBtn.addEventListener('mousedown', () => setPedal(true));
        pedalBtn.addEventListener('mouseup', () => setPedal(false));
        pedalBtn.addEventListener('mouseleave', () => setPedal(false));
        pedalBtn.addEventListener('touchstart', (e) => { e.preventDefault(); setPedal(true); }, { passive: false });
        pedalBtn.addEventListener('touchend', (e) => { e.preventDefault(); setPedal(false); }, { passive: false });

        // --- ‚ú® Gemini API Auto-Voicing System ---
        const aiBtn = document.getElementById('ai-btn');
        aiBtn.addEventListener('click', async () => {
            const aiInput = document.getElementById('ai-prompt');
            const prompt = aiInput.value.trim();
            if (!prompt) return;

            aiBtn.disabled = true; aiInput.disabled = true;
            aiBtn.innerText = "‚ú® THINKING..."; lcdMain.innerText = "ANALYZING..."; lcdMain.style.color = "#ffaa00";

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: { parts: [{ text: "You are a master piano technician. Translate user tone description into synth parameters. Unison 0-1, Hammer 0-1, Strike 0-1, Reverb 0-1. lcdName: max 16 chars uppercase." }] },
                    generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { unison: { type: "NUMBER" }, hammer: { type: "NUMBER" }, strike: { type: "NUMBER" }, reverb: { type: "NUMBER" }, lcdName: { type: "STRING" } }, required: ["unison", "hammer", "strike", "reverb", "lcdName"] } }
                };

                let response;
                for (let i of [1000, 2000, 4000]) {
                    response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (response.ok) break;
                    await new Promise(res => setTimeout(res, i));
                }
                
                const data = await response.json();
                const settings = JSON.parse(data.candidates[0].content.parts[0].text);
                
                document.getElementById('knob-unison').setValue(settings.unison);
                document.getElementById('knob-hammer').setValue(settings.hammer);
                document.getElementById('knob-strike').setValue(settings.strike);
                document.getElementById('knob-reverb').setValue(settings.reverb);
                
                presetSelect.value = ''; // Detach from preset
                lcdMain.innerText = settings.lcdName.toUpperCase();
                lcdMain.style.color = "var(--lcd-text)"; 
                
                initAudio();
                const testNotes = [{ idx: 40, name: 'C4' }, { idx: 44, name: 'E4' }, { idx: 47, name: 'G4' }, { idx: 52, name: 'C5' }];
                testNotes.forEach(n => playNote(n.idx, n.name, 0.7));
                setTimeout(() => { testNotes.forEach(n => releaseNote(n.name)); }, 1500);

            } catch (err) {
                console.error(err); lcdMain.innerText = "ERROR"; lcdMain.style.color = "#ff0000";
            } finally {
                aiBtn.disabled = false; aiInput.disabled = false; aiBtn.innerText = "‚ú® Auto-Voice";
            }
        });
        document.getElementById('ai-prompt').addEventListener('keypress', (e) => { if (e.key === 'Enter') aiBtn.click(); });

        // --- Steinway Engine (Dynamic Physical Modeling with Velocity) ---
        // velocity parameter added (0.0 to 1.0)
        function playNote(noteIndex, noteName, velocity = 0.7) {
            initAudio();
            if(!audioCtx) return;
            const now = audioCtx.currentTime;

            if (activeVoices[noteName]) activeVoices[noteName].stop(now);

            // Shape the velocity response curve (exponential feels more natural)
            const velCurve = Math.pow(velocity, 2); 

            const frequency = params.diapason * Math.pow(2, (noteIndex - 49) / 12);
            const minFreq = 27.5; 
            const decayTime = Math.max(1.5, 8 - (Math.log2(frequency / minFreq) * 1.2));

            const voiceGain = audioCtx.createGain();
            voiceGain.gain.setValueAtTime(0, now);
            
            const attackTime = 0.002 + ((1 - params.hammer) * 0.015);
            const safeVolume = Math.max(0.001, params.volume * velCurve * 1.5);
            
            voiceGain.gain.linearRampToValueAtTime(safeVolume, now + attackTime);
            voiceGain.gain.exponentialRampToValueAtTime(0.001, now + decayTime);

            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            // Velocity greatly impacts brightness (filter cutoff)
            const cutoff = frequency * (2 + (params.hammer * 10 * velocity));
            filter.frequency.setValueAtTime(Math.min(cutoff, 22000), now); 
            filter.frequency.exponentialRampToValueAtTime(frequency * 1.5 + 200, now + decayTime * 0.4);

            const B = 0.00015; 
            const partials = [
                { mult: 1, vol: 1.00, type: 'triangle' }, { mult: 2, vol: 0.65, type: 'sine' },     
                { mult: 3, vol: 0.45, type: 'sine' },     { mult: 4, vol: 0.20, type: 'sine' },     
                { mult: 5, vol: 0.06, type: 'sine' },     { mult: 6, vol: 0.04, type: 'sine' },     
                { mult: 8, vol: 0.02, type: 'sine' }      
            ];

            const oscillators = [];

            partials.forEach(p => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = p.type;
                
                const n = p.mult;
                const pFreq = frequency * n * Math.sqrt(1 + B * n * n);
                osc.frequency.value = pFreq;

                let pVol = p.vol;
                if (pFreq > 6000) pVol *= 0.5;
                if (pFreq > 10000) pVol *= 0.1;

                const safePVol = Math.max(0.001, pVol);
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(safePVol, now + attackTime);
                gain.gain.exponentialRampToValueAtTime(0.0001, now + (decayTime / Math.sqrt(n)));

                osc.connect(gain); gain.connect(filter); osc.start(now); osc.stop(now + decayTime + 0.5);
                oscillators.push(osc);
            });

            if (params.unison > 0) {
                const uOsc = audioCtx.createOscillator(); const uGain = audioCtx.createGain();
                uOsc.type = 'triangle'; uOsc.frequency.value = (frequency * Math.sqrt(1 + B)) + (params.unison * 3); 
                uGain.gain.setValueAtTime(0, now); uGain.gain.linearRampToValueAtTime(0.4, now + attackTime); uGain.gain.exponentialRampToValueAtTime(0.0001, now + decayTime);
                uOsc.connect(uGain); uGain.connect(filter); uOsc.start(now); uOsc.stop(now + decayTime + 0.5);
                oscillators.push(uOsc);
            }

            const thumpOsc = audioCtx.createOscillator(); const thumpGain = audioCtx.createGain();
            thumpOsc.type = 'sine'; thumpOsc.frequency.setValueAtTime(80, now); thumpOsc.frequency.exponentialRampToValueAtTime(25, now + 0.06);
            // Thump scales with velocity
            const safeStrike = Math.max(0.001, 0.5 * params.strike * velocity);
            thumpGain.gain.setValueAtTime(0, now); thumpGain.gain.linearRampToValueAtTime(safeStrike, now + 0.002); thumpGain.gain.exponentialRampToValueAtTime(0.001, now + 0.04); 
            thumpOsc.connect(thumpGain); thumpGain.connect(filter); thumpOsc.start(now); thumpOsc.stop(now + 0.1);
            oscillators.push(thumpOsc);

            const noiseOsc = audioCtx.createOscillator(); const noiseGain = audioCtx.createGain();
            noiseOsc.type = 'square'; noiseOsc.frequency.setValueAtTime(frequency * 3.5, now);
            // Chiff scales with velocity
            const safeHammer = Math.max(0.001, 0.04 * params.hammer * velocity);
            noiseGain.gain.setValueAtTime(0, now); noiseGain.gain.linearRampToValueAtTime(safeHammer, now + 0.003); noiseGain.gain.exponentialRampToValueAtTime(0.001, now + 0.08);
            noiseOsc.connect(noiseGain); noiseGain.connect(filter); noiseOsc.start(now); noiseOsc.stop(now + 0.1);
            oscillators.push(noiseOsc);

            filter.connect(voiceGain);
            voiceGain.connect(globalBus); 

            let stopped = false;
            activeVoices[noteName] = {
                stop: (time) => {
                    if (stopped) return; stopped = true;
                    try {
                        voiceGain.gain.cancelScheduledValues(time);
                        voiceGain.gain.setTargetAtTime(0, time, 0.03); 
                        setTimeout(() => { try { oscillators.forEach(o => o.stop()); voiceGain.disconnect(); } catch(e){} }, 300);
                    } catch(e) {}
                }
            };
        }

        function releaseNote(noteName) {
            heldKeys.delete(noteName);
            if (!isSustainPedalDown && activeVoices[noteName]) {
                activeVoices[noteName].stop(audioCtx.currentTime);
                delete activeVoices[noteName];
            }
        }

        // --- Render UI ---
        notes.forEach((note) => {
            const keyDiv = document.createElement('div');
            keyDiv.classList.add('key', `${note.type}-key`);
            keyDiv.id = `key-${note.name}`;
            keyDiv.innerHTML = `<span class="note-name" data-note="${note.name}">${note.name}</span><span class="key-bind"></span>`;
            if (note.type === 'white') whiteKeyCount++; 
            else keyDiv.style.left = `calc(var(--white-key-width) * ${whiteKeyCount})`; 

            // Calculate Mouse/Touch Velocity based on Y position
            const handleInteract = (e) => {
                if(e.cancelable) e.preventDefault(); 
                if (!keyDiv.classList.contains('active')) {
                    heldKeys.add(note.name);
                    
                    // Mouse/Touch Velocity Logic
                    let clientY;
                    if (e.touches && e.touches.length > 0) clientY = e.touches[0].clientY;
                    else if (e.clientY) clientY = e.clientY;
                    
                    let velocity = 0.7; // default
                    if (clientY !== undefined) {
                        const rect = keyDiv.getBoundingClientRect();
                        // Click near the bottom = 1.0 (hard). Near the top = 0.2 (soft).
                        velocity = (clientY - rect.top) / rect.height;
                        velocity = Math.max(0.2, Math.min(1.0, velocity)); 
                    }

                    playNote(note.index, note.name, velocity);
                    keyDiv.classList.add('active');
                }
            };

            const triggerRelease = (e) => {
                if(e.cancelable) e.preventDefault();
                keyDiv.classList.remove('active');
                releaseNote(note.name);
            };

            keyDiv.addEventListener('mousedown', handleInteract);
            keyDiv.addEventListener('mouseup', triggerRelease);
            keyDiv.addEventListener('mouseleave', triggerRelease);
            keyDiv.addEventListener('mouseenter', (e) => { if (e.buttons === 1) handleInteract(e); });
            keyDiv.addEventListener('touchstart', handleInteract, { passive: false });
            keyDiv.addEventListener('touchend', triggerRelease, { passive: false });
            keyDiv.addEventListener('touchcancel', triggerRelease, { passive: false });

            pianoContainer.appendChild(keyDiv);
        });

        // --- Octave Shift Controller ---
        function setOctaveShift(shift) {
            currentOctaveShift = Math.max(-3, Math.min(3, shift));
            for (let k in keyElements) {
                keyElements[k].isPressed = false;
                if(keyElements[k].div) keyElements[k].div.classList.remove('active');
                delete keyElements[k];
            }
            document.querySelectorAll('.key-bind').forEach(el => el.innerText = '');
            const shiftLabel = document.getElementById('octave-shift-label');
            if(shiftLabel) shiftLabel.innerText = currentOctaveShift > 0 ? "+" + currentOctaveShift : currentOctaveShift;

            for (let code in baseKeyMap) {
                const noteIndex = 39 + baseKeyMap[code] + (currentOctaveShift * 12);
                if (noteIndex >= 0 && noteIndex < 88) {
                    const note = notes[noteIndex];
                    const div = document.getElementById(`key-${note.name}`);
                    if(div) {
                        keyElements[code] = { div: div, note: note, isPressed: false };
                        div.querySelector('.key-bind').innerText = keyDisplayMap[code];
                    }
                }
            }
        }

        // Initialize parameters, Knobs, and Map on Load
        window.addEventListener('load', () => {
            setupKnob('knob-diapason', 'diapason', 415, 465, 440); 
            setupKnob('knob-unison', 'unison', 0.0, 1.0, 0.2); 
            setupKnob('knob-hammer', 'hammer', 0.0, 1.0, 0.5); 
            setupKnob('knob-strike', 'strike', 0.0, 1.0, 0.5); 
            setupKnob('knob-reverb', 'reverb', 0.0, 1.0, 0.4); 
            setupKnob('knob-volume', 'volume', 0.0, 1.0, 0.8);
            setOctaveShift(0);
            document.getElementById('octave-down').addEventListener('click', () => setOctaveShift(currentOctaveShift - 1));
            document.getElementById('octave-up').addEventListener('click', () => setOctaveShift(currentOctaveShift + 1));
        });

        // Global Keyboard Listeners (Computer Keyboard is fixed at 0.7 velocity)
        window.addEventListener('keydown', (e) => {
            if (e.repeat || document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'SELECT') return; 
            
            if (e.code === 'Space') { e.preventDefault(); setPedal(true); return; }
            if (e.code === 'ArrowLeft') { e.preventDefault(); setOctaveShift(currentOctaveShift - 1); return; }
            if (e.code === 'ArrowRight') { e.preventDefault(); setOctaveShift(currentOctaveShift + 1); return; }

            const noteData = keyElements[e.code];
            if (noteData && !noteData.isPressed) {
                noteData.isPressed = true;
                heldKeys.add(noteData.note.name);
                playNote(noteData.note.index, noteData.note.name, 0.7); // Static velocity for PC keyboard
                noteData.div.classList.add('active');
            }
        });

        window.addEventListener('keyup', (e) => {
            if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'SELECT') return;
            if (e.code === 'Space') { e.preventDefault(); setPedal(false); return; }

            const noteData = keyElements[e.code];
            if (noteData) {
                noteData.isPressed = false;
                noteData.div.classList.remove('active');
                releaseNote(noteData.note.name);
            }
        });

    </script>
</body>
</html>